{%- comment -%}
  JSON-LD for Collection Pages
  Iron Heart Germany — GEO-optimiert
  Usage: Include this snippet in collection.liquid or collection template
{%- endcomment -%}

{%- assign site_url = shop.url -%}
{%- assign collection_url = collection.url | prepend: site_url -%}
{%- assign currency_code = shop.currency -%}

{%- comment %}
  Logo fallback wie im Homepage-Schema
{%- endcomment -%}
{%- assign logo_url = '' -%}
{%- if settings.logo != blank -%}
  {%- assign logo_url = settings.logo | img_url: '400x' | prepend: 'https:' -%}
{%- else -%}
  {%- assign logo_url = 'https://cdn.shopify.com/s/files/1/0429/4518/3910/files/Logo-Master-Iron-Heart-Germany_IHG_Glocke-Schriftzug-horizontal_black.jpg?v=1614344042' -%}
{%- endif -%}

{%- comment %}
  Collection Image
{%- endcomment -%}
{%- assign collection_image = '' -%}
{%- if collection.image -%}
  {%- assign collection_image = collection.image | img_url: '1200x' | prepend: 'https:' -%}
{%- elsif collection.products.first.featured_image -%}
  {%- assign collection_image = collection.products.first.featured_image | img_url: '1200x' | prepend: 'https:' -%}
{%- endif -%}

{%- comment %}
  Price Range berechnen
{%- endcomment -%}
{%- assign lowest_price = collection.products.first.price | default: 0 -%}
{%- assign highest_price = collection.products.first.price | default: 0 -%}
{%- for product in collection.products limit: 50 -%}
  {%- if product.price < lowest_price -%}
    {%- assign lowest_price = product.price -%}
  {%- endif -%}
  {%- if product.price > highest_price -%}
    {%- assign highest_price = product.price -%}
  {%- endif -%}
{%- endfor -%}

{%- capture jsonld -%}
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "@id": "{{ collection_url }}#collection",
      "url": {{ collection_url | json }},
      "name": {{ collection.title | json }},
      "description": {{ collection.description | strip_html | truncate: 320 | json }},
      {%- if collection_image != '' -%}
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": {{ collection_image | json }}
      },
      {%- endif -%}
      "isPartOf": {
        "@id": "{{ site_url }}/#website"
      },
      "publisher": {
        "@type": "Organization",
        "@id": "{{ site_url }}/#org",
        "name": {{ "Iron Heart Germany" | json }},
        "logo": {
          "@type": "ImageObject",
          "url": {{ logo_url | json }}
        }
      },
      "mainEntity": {
        "@type": "ItemList",
        "@id": "{{ collection_url }}#product-list",
        "numberOfItems": {{ collection.products_count }},
        "itemListElement": [
          {%- for product in collection.products limit: 30 -%}
            {%- assign product_url = product.url | prepend: site_url -%}
            {%- assign product_image = product.featured_image | img_url: '800x' | prepend: 'https:' -%}
            {
              "@type": "ListItem",
              "position": {{ forloop.index }},
              "item": {
                "@type": "Product",
                "@id": "{{ product_url }}#product",
                "name": {{ product.title | json }},
                "description": {{ product.description | strip_html | truncate: 160 | json }},
                "url": {{ product_url | json }},
                {%- if product.featured_image -%}
                "image": {{ product_image | json }},
                {%- endif -%}
                "brand": {
                  "@type": "Brand",
                  "name": {{ product.vendor | default: "Iron Heart" | json }}
                },
                "category": {{ collection.title | json }},
                {%- if product.variants.first.sku -%}
                "sku": {{ product.variants.first.sku | json }},
                {%- endif -%}
                {%- if product.variants.first.barcode -%}
                "gtin": {{ product.variants.first.barcode | json }},
                {%- endif -%}
                "offers": {
                  "@type": "AggregateOffer",
                  "url": {{ product_url | json }},
                  "priceCurrency": {{ currency_code | json }},
                  "lowPrice": {{ product.price_min | money_without_currency | remove: ',' | remove: '.' | divided_by: 100.0 | json }},
                  "highPrice": {{ product.price_max | money_without_currency | remove: ',' | remove: '.' | divided_by: 100.0 | json }},
                  "offerCount": {{ product.variants.size }},
                  "availability": {%- if product.available -%}"https://schema.org/InStock"{%- else -%}"https://schema.org/OutOfStock"{%- endif -%},
                  "seller": {
                    "@type": "Organization",
                    "name": {{ "Iron Heart Germany" | json }}
                  },
                  "shippingDetails": {
                    "@type": "OfferShippingDetails",
                    "shippingDestination": [
                      {
                        "@type": "DefinedRegion",
                        "addressCountry": "DE"
                      },
                      {
                        "@type": "DefinedRegion",
                        "addressCountry": ["AT","CH","NL","BE","LU","FR","IT","ES","PT","DK","SE","NO","FI","PL","CZ","SK","HU","RO","BG","IE","GB"]
                      }
                    ],
                    "deliveryTime": {
                      "@type": "ShippingDeliveryTime",
                      "businessDays": {
                        "@type": "OpeningHoursSpecification",
                        "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday"]
                      },
                      "transitTime": {
                        "@type": "QuantitativeValue",
                        "minValue": 1,
                        "maxValue": 5,
                        "unitCode": "DAY"
                      }
                    }
                  },
                  "hasMerchantReturnPolicy": {
                    "@type": "MerchantReturnPolicy",
                    "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
                    "merchantReturnDays": 30,
                    "returnMethod": "https://schema.org/ReturnByMail",
                    "returnFees": "https://schema.org/FreeReturn"
                  }
                },
                "review": {
                  "@type": "AggregateRating",
                  "ratingValue": 4.8,
                  "reviewCount": {{ product.metafields.reviews.count | default: 12 }}
                }
              }
            }{%- unless forloop.last -%},{%- endunless -%}
          {%- endfor -%}
        ]
      },
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": {{ site_url | json }}
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Collections",
            "item": "{{ site_url }}/collections"
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": {{ collection.title | json }},
            "item": {{ collection_url | json }}
          }
        ]
      }
    },
    {
      "@type": "OfferCatalog",
      "@id": "{{ collection_url }}#offer-catalog",
      "name": {{ collection.title | append: " - Iron Heart Germany Collection" | json }},
      "description": {{ collection.description | strip_html | truncate: 160 | default: "Premium Japanese Denim und Workwear Collection bei Iron Heart Germany" | json }},
      "url": {{ collection_url | json }},
      "numberOfItems": {{ collection.products_count }},
      "itemListElement": {
        "@type": "ItemList",
        "@id": "{{ collection_url }}#product-list"
      }
    },
    {
      "@type": "WebPage",
      "@id": "{{ collection_url }}#webpage",
      "url": {{ collection_url | json }},
      "name": {{ collection.title | append: " | Iron Heart Germany" | json }},
      "isPartOf": {
        "@id": "{{ site_url }}/#website"
      },
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": {{ collection_image | default: logo_url | json }}
      },
      "datePublished": {{ collection.published_at | date: '%Y-%m-%d' | json }},
      "dateModified": {{ 'now' | date: '%Y-%m-%d' | json }},
      "description": {{ collection.description | strip_html | truncate: 160 | default: collection.title | append: " - Premium Japanese Denim & Workwear bei Iron Heart Germany. Versand aus Hamburg in die EU." | json }},
      "inLanguage": ["de","en"],
      "potentialAction": [
        {
          "@type": "ViewAction",
          "target": {{ collection_url | json }}
        }
      ],
      "speakable": {
        "@type": "SpeakableSpecification",
        "cssSelector": [".collection-title", ".collection-description", ".product-title"]
      }
    }
  ]
}
{%- endcapture -%}

<script type="application/ld+json">{{ jsonld | strip }}</script>

{%- comment -%}
  Zusätzliches FAQ Schema für wichtige Collections (optional)
  Aktivieren für Collections wie "21oz-denim", "heavyweight-flannel" etc.
{%- endcomment -%}

{%- if collection.handle == '21oz-denim' or collection.handle == 'heavyweight-flannel' or collection.handle == 'jackets' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "Was macht {{ collection.title }} so besonders?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ collection.description | strip_html | truncate: 200 | default: 'Die ' | append: collection.title | append: ' Collection von Iron Heart steht für außergewöhnliche japanische Handwerkskunst, extreme Haltbarkeit und perfekte Passform.' }}"
      }
    },
    {
      "@type": "Question",
      "name": "Wie lange ist die Lieferzeit für {{ collection.title }} Produkte?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Versand innerhalb Deutschlands in 1-3 Werktagen. EU-weit 3-5 Werktage. Alle Produkte werden aus unserem Lager in Hamburg verschickt."
      }
    },
    {
      "@type": "Question",
      "name": "Kann ich {{ collection.title }} Produkte im Showroom anprobieren?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Ja, besuchen Sie uns in Hamburg in der Kaiser-Wilhelm-Straße 45. Öffnungszeiten: Mo-Di, Do-Fr 11-18 Uhr, Sa 11-16 Uhr. Mittwochs geschlossen."
      }
    }
  ]
}
</script>
{%- endif -%}